Bootstrap: docker
From: python:3.12

%files
    requirements.txt /requirements.txt

%environment
    export PYTHONUNBUFFERED=1

%post
    pip install --upgrade pip
    pip install -r requirements.txt

    # install bitsandbytes and triton separately (not available on MacOS)
    pip install bitsandbytes==0.45.5 triton==3.1.0 
    pip install accelerate==1.8.1 liger-kernel==0.5.10
    pip install --no-build-isolation flash-attn==2.8.0.post2

%runscript
    if [ -z "$NUM_GPUS" ]; then
        echo "Error: $NUM_GPUS is not set. Please re-run with --env NUM_GPUS=..."
        exit 1
    fi

    if [ "$NUM_GPUS" -gt 1 ]; then
        python optuna_optimizer.py \
            --fine_tune_job_id $FINE_TUNE_JOB_ID \
            --gpu_indexes $GPU_INDEXES \
            --num_gpus $NUM_GPUS \
            --use_accelerate
    else
        python optuna_optimizer.py \
            --fine_tune_job_id $FINE_TUNE_JOB_ID \
            --gpu_indexes $GPU_INDEXES \
            --num_gpus $NUM_GPUS
    fi


%labels
    Author luka.panic@pixion.co
    Version v0.0.1

%help
    Description:
        A script for LoRA from Hugging Face.

    Build:
        apptainer build lora.sif lora.def

    Environment:
        - .env.hpc

    Usage:
        apptainer run \
            --nv \
            --bind ...
            --env-file .env.hpc \
            --env http_proxy=...
            --env https_proxy=...
            --env FINE_TUNE_JOB_ID=...
            --env NUM_GPUS=...
            --env GPU_INDEXES=...
            lora.sif