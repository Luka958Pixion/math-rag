Bootstrap: docker
From: ghcr.io/huggingface/text-generation-inference:latest

%files
    server_startscript.sh /opt/

%post
    set -e
    PROMETHEUS_VERSION=3.3.0
    curl -sL https://github.com/prometheus/prometheus/releases/download/v${PROMETHEUS_VERSION}/prometheus-${PROMETHEUS_VERSION}.linux-amd64.tar.gz -o /tmp/prom.tar.gz
    mkdir -p /opt
    tar --no-same-owner -xzf /tmp/prom.tar.gz -C /opt
    mv /opt/prometheus-${PROMETHEUS_VERSION}.linux-amd64 /opt/prometheus
    rm /tmp/prom.tar.gz

    chmod +x /opt/server_startscript.sh

%startscript
    exec bash /opt/server_startscript.sh

%labels
    Author luka.panic@pixion.co
    Version v0.0.1

%help
    Description:
        A server for Text Generation Inference (TGI) from Hugging Face.

    Build:
        apptainer build server.sif server.def

    Environment:
        - MODEL_HUB_ID
        - LORA_ADAPTERS

    Usage:
        apptainer instance start \
            --nv \
            --bind "$PWD/mount/$MODEL_HUB_ID:/model,$PWD/data:/data" \
            --env LORA_ADAPTERS=$LORA_ADAPTERS \
            server.sif \
            tgi_server_instance